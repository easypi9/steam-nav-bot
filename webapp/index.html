<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>STEAM –ù–∞–≤–∏–≥–∞—Ü–∏—è</title>
    <style>
      :root { --bg:#0b1220; --panel:#111a2e; --card:#0f1930; --text:#e8eefc; --muted:#a9b7db; --accent:#6aa7ff; --danger:#ff6a6a; }
      * { box-sizing: border-box; }
      body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); }
      .app { display:flex; min-height:100vh; }
      .sidebar { width: 280px; background:var(--panel); padding:16px; border-right: 1px solid rgba(255,255,255,.08); }
      .brand { font-weight:900; letter-spacing:.2px; margin-bottom:10px; }
      .sub { color:var(--muted); font-size:13px; margin-bottom:14px; line-height:1.35; }
      .nav { display:flex; flex-direction:column; gap:8px; }
      .btn{
        width:100%; text-align:left; padding:12px 12px; border-radius:12px;
        border: 1px solid rgba(255,255,255,.10);
        background: rgba(255,255,255,.04); color:var(--text); cursor:pointer;
        display:flex; justify-content:space-between; align-items:center;
      }
      .btn:hover { border-color: rgba(106,167,255,.45); }
      .btn.active { outline: 2px solid rgba(106,167,255,.55); background: rgba(106,167,255,.10); }
      .tag { font-size:12px; color:var(--muted); }
      .main { flex:1; padding:18px; }
      .top { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:14px; flex-wrap:wrap; }
      .title { font-size:18px; font-weight:900; }
      .pill { padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); color:var(--muted); font-size:12px; white-space:nowrap; }
      .pill.ok { color: var(--text); border-color: rgba(106,167,255,.55); }
      .pill.bad { color: var(--danger); border-color: rgba(255,106,106,.45); }
      .cards { display:grid; grid-template-columns: 1fr; gap:12px; }
      .card{
        background: var(--card);
        border: 1px solid rgba(255,255,255,.10);
        border-radius:16px;
        padding:14px;
      }
      .row { display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
      .muted { color:var(--muted); font-size:13px; line-height:1.45; }
      .small { font-size:12px; color:var(--muted); margin-top:8px; }
      .list { display:flex; flex-direction:column; gap:10px; margin-top:10px; }
      .item { padding:12px; border-radius:14px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.03); }
      .itemTitle { font-weight:800; }
      .itemSub { margin-top:6px; font-size:12px; color:var(--muted); display:flex; gap:10px; flex-wrap:wrap; }
      a { color: var(--accent); text-decoration:none; font-weight:750; }
      a:hover { text-decoration: underline; }
      code { color: var(--text); }
      .miniBtn{
        display:inline-flex; align-items:center; gap:8px;
        padding:8px 10px; border-radius:999px;
        border:1px solid rgba(255,255,255,.12);
        background: rgba(255,255,255,.04);
        color: var(--text);
        cursor:pointer;
        font-size:12px;
        text-decoration:none;
      }
      .miniBtn:hover{ border-color: rgba(106,167,255,.45); }
      @media (max-width: 820px) { .sidebar { width: 220px; } }
      @media (max-width: 650px) {
        .app { flex-direction: column; }
        .sidebar { width:100%; border-right:none; border-bottom: 1px solid rgba(255,255,255,.08); }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <aside class="sidebar">
        <div class="brand">üìö STEAM –ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
        <div class="sub" id="sub">
          WebApp —á–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ API (–ª–æ–∫–∞–ª—å–Ω–æ –∏–ª–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞).
        </div>

        <nav class="nav" id="nav"></nav>

        <div class="small" id="tgHint"></div>
        <div class="small" id="apiHint"></div>
      </aside>

      <main class="main">
        <div class="top">
          <div class="title" id="screenTitle">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <a class="miniBtn" id="chatBtn" href="#" target="_blank" rel="noopener" style="display:none;">üí¨ –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</a>
            <div class="pill" id="pill">offline</div>
          </div>
        </div>

        <div class="cards" id="content"></div>
      </main>
    </div>

    <script>
      const DEFAULT_API = "http://127.0.0.1:3000";
      const qs = new URLSearchParams(location.search);
      const API = (qs.get("api") || DEFAULT_API).replace(/\/+$/, "");

      const sections = [
        { key: "continue", label: "‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å", desc: "–¢–≤–æ—è —Ç–æ—á–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞." },
        { key: "prep", label: "üß© –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã–π –∫—É—Ä—Å", desc: "–£—Ä–æ–∫–∏ —Å –Ω—É–ª—è: –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ STEAM." },
        { key: "steam", label: "üöÄ –ö—É—Ä—Å STEAM", desc: "–û—Å–Ω–æ–≤–Ω–æ–π –∫—É—Ä—Å, –º–æ–¥—É–ª–∏ –∏ –ø—Ä–∞–∫—Ç–∏–∫–∞." },
        { key: "news", label: "üóû –ù–æ–≤–æ—Å—Ç–∏", desc: "–ê–Ω–æ–Ω—Å—ã, –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, —Å–æ–±—ã—Ç–∏—è." },
        { key: "links", label: "üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏", desc: "–†–µ—Å—É—Ä—Å—ã, —Å–µ—Ä–≤–∏—Å—ã, –º–∞—Ç–µ—Ä–∏–∞–ª—ã." },
      ];

      const navEl = document.getElementById("nav");
      const contentEl = document.getElementById("content");
      const titleEl = document.getElementById("screenTitle");
      const pillEl = document.getElementById("pill");
      const tgHintEl = document.getElementById("tgHint");
      const apiHintEl = document.getElementById("apiHint");
      const chatBtn = document.getElementById("chatBtn");

      const tg = window.Telegram?.WebApp;
      const userId = tg?.initDataUnsafe?.user?.id || null;

      let META = { channel_username: "", chat_url: "" };

      function setPillOk(text){
        pillEl.textContent = text;
        pillEl.classList.remove("bad");
        pillEl.classList.add("ok");
      }
      function setPillBad(text){
        pillEl.textContent = text;
        pillEl.classList.remove("ok");
        pillEl.classList.add("bad");
      }

      if (tg) {
        setPillOk("telegram webapp");
        tgHintEl.textContent = userId
          ? `Telegram user_id: ${userId}`
          : "–û—Ç–∫—Ä—ã—Ç–æ –≤ Telegram ‚úÖ (user_id –Ω–µ –Ω–∞–π–¥–µ–Ω)";
        try { tg.expand(); } catch {}
      } else {
        setPillOk("browser");
        tgHintEl.textContent = "–û—Ç–∫—Ä—ã—Ç–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä).";
      }

      apiHintEl.innerHTML = `API: <code>${API}</code> (–º–æ–∂–Ω–æ —Å–º–µ–Ω–∏—Ç—å —á–µ—Ä–µ–∑ <code>?api=...</code>)`;

      function setActive(key) {
        document.querySelectorAll(".btn").forEach(b => b.classList.toggle("active", b.dataset.key === key));
      }

      function renderNav() {
        navEl.innerHTML = "";
        sections.forEach(s => {
          const btn = document.createElement("button");
          btn.className = "btn";
          btn.dataset.key = s.key;
          btn.innerHTML = `<span>${s.label}</span><span class="tag">—Ä–∞–∑–¥–µ–ª</span>`;
          btn.onclick = () => { setActive(s.key); renderSection(s.key); };
          navEl.appendChild(btn);
        });
      }

      function card(title, bodyHtml) {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <div class="row">
            <div style="font-weight:900">${title}</div>
          </div>
          <div class="muted" style="margin-top:8px; white-space:pre-line">${bodyHtml}</div>
        `;
        return div;
      }

      function listCard(title, itemsHtml) {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <div class="row">
            <div style="font-weight:900">${title}</div>
          </div>
          <div class="list">${itemsHtml}</div>
        `;
        return div;
      }

      async function apiGet(path) {
        const url = API + path;
        const r = await fetch(url);
        if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
        return await r.json();
      }

      function itemHtml(title, subHtml, linkUrl) {
        const titleHtml = linkUrl
          ? `<a href="${linkUrl}" target="_blank" rel="noopener">${title}</a>`
          : `<span class="itemTitle">${title}</span>`;
        return `
          <div class="item">
            <div class="itemTitle">${titleHtml}</div>
            <div class="itemSub">${subHtml || ""}</div>
          </div>
        `;
      }

      async function loadMeta() {
        try {
          const m = await apiGet("/meta");
          META = { channel_username: m.channel_username || "", chat_url: m.chat_url || "" };

          if (META.chat_url) {
            chatBtn.href = META.chat_url;
            chatBtn.style.display = "inline-flex";
          }
        } catch (e) {
          // meta –Ω–µ –∫—Ä–∏—Ç–∏—á–µ–Ω
        }
      }

      async function renderContinue() {
        titleEl.textContent = "‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å";
        contentEl.innerHTML = "";

        if (!userId) {
          contentEl.appendChild(card(
            "–ù–µ—Ç user_id",
            "–û—Ç–∫—Ä–æ–π WebApp –∏–∑ Telegram, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å.\n–°–µ–π—á–∞—Å –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–¥–µ–ª—ã."
          ));
          return;
        }

        try {
          const data = await apiGet(`/progress?user_id=${encodeURIComponent(userId)}`);
          const items = data.items || [];
          if (!items.length) {
            contentEl.appendChild(card(
              "–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞",
              "–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ—è–≤–∏—Ç—Å—è, –∫–æ–≥–¥–∞ —Ç—ã –æ—Ç–º–µ—Ç–∏—à—å —É—Ä–æ–∫ –∫–∞–∫ —Ç–µ–∫—É—â–∏–π –≤ –±–æ—Ç–µ (–∫–Ω–æ–ø–∫–∞ ¬´‚úÖ –¢–µ–∫—É—â–∏–π¬ª)."
            ));
            return;
          }

          const html = items.map(i => {
            const secLabel = (i.section === "prep") ? "üß© –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞" : "üöÄ STEAM";
            const title = i.title ? `${secLabel} ‚Äî ${i.ord}. ${i.title}` : `${secLabel} ‚Äî —É—Ä–æ–∫ ${i.ord}`;
            const sub = `updated: ${i.updated_at || "-"}` + (i.message_id ? ` ‚Ä¢ message_id: ${i.message_id}` : "");
            return itemHtml(title, sub, i.post_url || null);
          }).join("");

          contentEl.appendChild(listCard("–¢–≤–æ–∏ —Ç–æ—á–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞", html));
        } catch (e) {
          setPillBad("api error");
          contentEl.appendChild(card("API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω", String(e)));
        }
      }

      async function renderLessons(sectionKey) {
        const label = sectionKey === "prep" ? "üß© –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã–π –∫—É—Ä—Å" : "üöÄ –ö—É—Ä—Å STEAM";
        titleEl.textContent = label;
        contentEl.innerHTML = "";

        try {
          const data = await apiGet(`/lessons?section=${encodeURIComponent(sectionKey)}`);
          const items = data.items || [];
          if (!items.length) {
            contentEl.appendChild(card("–ü–æ–∫–∞ –ø—É—Å—Ç–æ", "–£—Ä–æ–∫–∏ –ø–æ—è–≤—è—Ç—Å—è, –∫–æ–≥–¥–∞ —Ç—ã –¥–æ–±–∞–≤–∏—à—å –∏—Ö —á–µ—Ä–µ–∑ /add_lesson –≤ –±–æ—Ç–µ."));
            return;
          }

          const html = items.map(it => {
            const sub = `message_id: ${it.message_id}`;
            return itemHtml(`${it.ord}. ${it.title}`, sub, it.post_url || null);
          }).join("");

          contentEl.appendChild(listCard("–£—Ä–æ–∫–∏", html));
        } catch (e) {
          setPillBad("api error");
          contentEl.appendChild(card("API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω", String(e)));
        }
      }

      async function renderNews() {
        titleEl.textContent = "üóû –ù–æ–≤–æ—Å—Ç–∏";
        contentEl.innerHTML = "";

        try {
          const data = await apiGet(`/news`);
          const items = data.items || [];
          if (!items.length) {
            contentEl.appendChild(card("–ü–æ–∫–∞ –Ω–µ—Ç –Ω–æ–≤–æ—Å—Ç–µ–π", "–î–æ–±–∞–≤–ª—è–π #news –≤ –ø–æ—Å—Ç—ã –∫–∞–Ω–∞–ª–∞ ‚Äî –±–æ—Ç –∏—Ö —Å–æ–±–µ—Ä—ë—Ç."));
            return;
          }

          const html = items.slice(0, 50).map((it, idx) => {
            const sub = `message_id: ${it.message_id}` + (it.created_at ? ` ‚Ä¢ ${it.created_at}` : "");
            return itemHtml(`–ù–æ–≤–æ—Å—Ç—å ${idx + 1}`, sub, it.post_url || null);
          }).join("");

          contentEl.appendChild(listCard("–ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏", html));
        } catch (e) {
          setPillBad("api error");
          contentEl.appendChild(card("API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω", String(e)));
        }
      }

      async function renderLinks() {
        titleEl.textContent = "üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏";
        contentEl.innerHTML = "";

        try {
          const data = await apiGet(`/links`);
          const items = data.items || [];
          if (!items.length) {
            contentEl.appendChild(card("–ü–æ–∫–∞ –ø—É—Å—Ç–æ", "–°—Å—ã–ª–∫–∏ –ø–æ—è–≤—è—Ç—Å—è, –∫–æ–≥–¥–∞ —Ç—ã –¥–æ–±–∞–≤–∏—à—å –∏—Ö —á–µ—Ä–µ–∑ /add_link –≤ –±–æ—Ç–µ."));
            return;
          }

          const html = items.map(it => itemHtml(it.title, `ord: ${it.ord}`, it.url)).join("");
          contentEl.appendChild(listCard("–°—Å—ã–ª–∫–∏", html));
        } catch (e) {
          setPillBad("api error");
          contentEl.appendChild(card("API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω", String(e)));
        }
      }

      async function renderSection(key) {
        setActive(key);
        location.hash = key;

        if (key === "continue") return renderContinue();
        if (key === "prep" || key === "steam") return renderLessons(key);
        if (key === "news") return renderNews();
        if (key === "links") return renderLinks();
      }

      // ---- init ----
      renderNav();
      loadMeta();

      const initial = (location.hash || "#prep").replace("#", "");
      renderSection(initial);
    </script>
  </body>
</html>
