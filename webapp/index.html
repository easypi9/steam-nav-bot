<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>STEAM –ù–∞–≤–∏–≥–∞—Ü–∏—è</title>
    <style>
      :root {
        --bg:#0b1220; --panel:#111a2e; --card:#0f1930; --text:#e8eefc; --muted:#a9b7db; --accent:#6aa7ff;
        --ok:#38d39f; --bad:#ff6a6a; --warn:#ffd36a;
        --line: rgba(255,255,255,.10);
      }
      * { box-sizing: border-box; }
      body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); }

      .app { display:flex; min-height:100vh; }
      .sidebar { width: 280px; background:var(--panel); padding:16px; border-right: 1px solid rgba(255,255,255,.08); }
      .brand { font-weight:800; letter-spacing:.2px; margin-bottom:10px; display:flex; gap:10px; align-items:center; }
      .sub { color:var(--muted); font-size:13px; margin-bottom:14px; line-height:1.35; }
      .nav { display:flex; flex-direction:column; gap:8px; }

      .btn {
        width:100%; text-align:left; padding:12px 12px; border-radius:12px;
        border: 1px solid rgba(255,255,255,.10);
        background: rgba(255,255,255,.04); color:var(--text); cursor:pointer;
        display:flex; justify-content:space-between; align-items:center;
      }
      .btn:hover { border-color: rgba(106,167,255,.45); }
      .btn.active { outline: 2px solid rgba(106,167,255,.55); background: rgba(106,167,255,.10); }
      .tag { font-size:12px; color:var(--muted); }

      .small { font-size:12px; color:var(--muted); margin-top:10px; white-space:pre-line; }

      .main { flex:1; padding:18px; }
      .top { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:14px; }
      .title { font-size:18px; font-weight:800; }
      .right { display:flex; gap:10px; align-items:center; }

      .pill {
        padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12);
        color:var(--muted); font-size:12px; user-select:none;
      }
      .pill.ok { border-color: rgba(56,211,159,.35); color: var(--ok); }
      .pill.bad { border-color: rgba(255,106,106,.35); color: var(--bad); }
      .pill.warn { border-color: rgba(255,211,106,.35); color: var(--warn); }

      .linkbtn{
        padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12);
        background: rgba(255,255,255,.04); color:var(--text); cursor:pointer; font-size:12px;
      }
      .linkbtn:hover{ border-color: rgba(106,167,255,.45); }

      .cards { display:grid; grid-template-columns: 1fr; gap:12px; }
      .card {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius:16px;
        padding:14px;
      }
      .row { display:flex; gap:10px; align-items:center; justify-content:space-between; }
      .muted { color:var(--muted); font-size:13px; line-height:1.45; }
      a { color: var(--accent); text-decoration: none; font-weight: 700; }
      a:hover { text-decoration: underline; }

      .list { display:flex; flex-direction:column; gap:10px; margin-top:10px; }
      .item {
        display:flex; justify-content:space-between; gap:12px; align-items:flex-start;
        padding:12px; border-radius:14px; border:1px solid rgba(255,255,255,.10);
        background: rgba(255,255,255,.03);
      }
      .item:hover { border-color: rgba(106,167,255,.40); }
      .itemTitle { font-weight:800; line-height:1.25; }
      .itemMeta { color:var(--muted); font-size:12px; margin-top:6px; }
      .itemRight { display:flex; gap:8px; align-items:center; flex-shrink:0; }

      .btn2 {
        padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12);
        background: rgba(255,255,255,.04); color:var(--text); cursor:pointer; font-weight:800; font-size:12px;
      }
      .btn2:hover { border-color: rgba(106,167,255,.45); }

      .empty {
        padding:14px; border-radius:16px; border:1px dashed rgba(255,255,255,.18);
        color:var(--muted); line-height:1.45;
      }

      @media (max-width: 820px) { .sidebar { width: 220px; } }
      @media (max-width: 650px) {
        .app { flex-direction: column; }
        .sidebar { width:100%; border-right:none; border-bottom: 1px solid rgba(255,255,255,.08); }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <aside class="sidebar">
        <div class="brand"><span>üìö</span><span>STEAM –ù–∞–≤–∏–≥–∞—Ü–∏—è</span></div>
        <div class="sub">–í—ã–±–∏—Ä–∞–π —Ä–∞–∑–¥–µ–ª –∏ –æ—Ç–∫—Ä—ã–≤–∞–π –º–∞—Ç–µ—Ä–∏–∞–ª—ã. –ï—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî —É–≤–∏–¥–∏—à—å –æ—à–∏–±–∫—É —Å–≤–µ—Ä—Ö—É.</div>
        <nav class="nav" id="nav"></nav>
        <div class="small" id="sideInfo"></div>
      </aside>

      <main class="main">
        <div class="top">
          <div class="title" id="screenTitle">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
          <div class="right">
            <button class="linkbtn" id="reloadBtn">‚Üª –û–±–Ω–æ–≤–∏—Ç—å</button>
            <div class="pill" id="tgPill">browser</div>
            <div class="pill" id="apiPill">API: ...</div>
          </div>
        </div>

        <div class="cards" id="content"></div>
      </main>
    </div>

    <script>
      // ====== CONFIG ======
      // –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å API —á–µ—Ä–µ–∑ ?api=https://....
      const qs = new URLSearchParams(location.search);
      const API_BASE =
        (qs.get("api") || "").trim() ||
        (localStorage.getItem("API_BASE") || "").trim() ||
        "https://steam-nav-bot-production.up.railway.app";

      // –ú–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å —Ä–∞–∑–¥–µ–ª —á–µ—Ä–µ–∑ ?section=prep
      const SECTION_FROM_QS = (qs.get("section") || "").trim();

      // –ß—Ç–æ–±—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤–æ–µ –±–µ–∑ –∫—ç—à–∞: –¥–æ–±–∞–≤–ª—è–π ?v=13 (–ª—é–±–æ–π –Ω–æ–º–µ—Ä)
      const NO_CACHE = { cache: "no-store" };

      const sections = [
        { key: "prep",  label: "üß© –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã–π –∫—É—Ä—Å", desc: "–£—Ä–æ–∫–∏ —Å –Ω—É–ª—è: –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ STEAM." },
        { key: "steam", label: "üöÄ –ö—É—Ä—Å STEAM",          desc: "–û—Å–Ω–æ–≤–Ω–æ–π –∫—É—Ä—Å, –º–æ–¥—É–ª–∏ –∏ –ø—Ä–∞–∫—Ç–∏–∫–∞." },
        { key: "news",  label: "üóû –ù–æ–≤–æ—Å—Ç–∏",             desc: "–ê–Ω–æ–Ω—Å—ã, –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, —Å–æ–±—ã—Ç–∏—è." },
        { key: "links", label: "üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏",     desc: "–†–µ—Å—É—Ä—Å—ã, —Å–µ—Ä–≤–∏—Å—ã, –º–∞—Ç–µ—Ä–∏–∞–ª—ã." },
      ];

      const navEl = document.getElementById("nav");
      const contentEl = document.getElementById("content");
      const titleEl = document.getElementById("screenTitle");
      const tgPillEl = document.getElementById("tgPill");
      const apiPillEl = document.getElementById("apiPill");
      const sideInfoEl = document.getElementById("sideInfo");
      const reloadBtn = document.getElementById("reloadBtn");

      function setActive(key) {
        document.querySelectorAll(".btn").forEach(b => b.classList.toggle("active", b.dataset.key === key));
      }

      function safeJson(obj) {
        try { return JSON.stringify(obj, null, 2); } catch { return String(obj); }
      }

      function card(title, subtitle, bodyNode) {
        const div = document.createElement("div");
        div.className = "card";

        const top = document.createElement("div");
        top.className = "row";

        const left = document.createElement("div");
        left.innerHTML = `<div style="font-weight:800">${title}</div>` + (subtitle ? `<div class="muted" style="margin-top:6px">${subtitle}</div>` : "");
        top.appendChild(left);

        div.appendChild(top);
        if (bodyNode) div.appendChild(bodyNode);
        return div;
      }

      function emptyBlock(text) {
        const d = document.createElement("div");
        d.className = "empty";
        d.textContent = text;
        return d;
      }

      function itemRow({ title, meta, url, rightLabel }) {
        const row = document.createElement("div");
        row.className = "item";

        const left = document.createElement("div");
        left.style.flex = "1";

        const t = document.createElement("div");
        t.className = "itemTitle";
        t.textContent = title;

        const m = document.createElement("div");
        m.className = "itemMeta";
        m.textContent = meta || "";

        left.appendChild(t);
        if (meta) left.appendChild(m);

        const right = document.createElement("div");
        right.className = "itemRight";

        if (url) {
          const a = document.createElement("a");
          a.href = url;
          a.target = "_blank";
          a.rel = "noreferrer";
          a.textContent = rightLabel || "–û—Ç–∫—Ä—ã—Ç—å";
          right.appendChild(a);
        }

        row.appendChild(left);
        row.appendChild(right);
        return row;
      }

      async function apiGet(path) {
        const url = API_BASE.replace(/\/$/, "") + path;
        const res = await fetch(url, NO_CACHE);
        const txt = await res.text();
        let data;
        try { data = JSON.parse(txt); } catch { data = { raw: txt }; }
        if (!res.ok) {
          const err = new Error(`HTTP ${res.status}`);
          err.data = data;
          err.url = url;
          throw err;
        }
        return { url, data };
      }

      async function markApiStatus() {
        try {
          await apiGet("/health");
          apiPillEl.textContent = "API: OK";
          apiPillEl.classList.remove("bad", "warn");
          apiPillEl.classList.add("ok");
          return true;
        } catch {
          apiPillEl.textContent = "API: ERROR";
          apiPillEl.classList.remove("ok", "warn");
          apiPillEl.classList.add("bad");
          return false;
        }
      }

      function renderNav() {
        navEl.innerHTML = "";
        sections.forEach(s => {
          const btn = document.createElement("button");
          btn.className = "btn";
          btn.dataset.key = s.key;
          btn.innerHTML = `<span>${s.label}</span><span class="tag">—Ä–∞–∑–¥–µ–ª</span>`;
          btn.onclick = () => {
            setActive(s.key);
            renderSection(s.key);
          };
          navEl.appendChild(btn);
        });
      }

      function getInitialSection() {
        // priority: ?section= , then #hash, else prep
        if (SECTION_FROM_QS && sections.some(x => x.key === SECTION_FROM_QS)) return SECTION_FROM_QS;
        const h = (location.hash || "").replace("#", "").trim();
        if (h && sections.some(x => x.key === h)) return h;
        return "prep";
      }

      function setHash(key) {
        location.hash = key;
      }

      function telegramInit() {
        const tg = window.Telegram?.WebApp;
        if (tg) {
          tgPillEl.textContent = "telegram";
          try { tg.expand(); } catch {}
        } else {
          tgPillEl.textContent = "browser";
        }
      }

      async function renderLessons(sectionKey) {
        const s = sections.find(x => x.key === sectionKey);
        const wrapper = document.createElement("div");
        wrapper.className = "list";

        const { data } = await apiGet(`/lessons?section=${encodeURIComponent(sectionKey)}`);
        const items = Array.isArray(data?.items) ? data.items : [];

        if (!items.length) {
          wrapper.appendChild(emptyBlock("–ü–æ–∫–∞ –Ω–µ—Ç —É—Ä–æ–∫–æ–≤ –≤ —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ. –°–∫–æ—Ä–æ –¥–æ–±–∞–≤–∏–º üöÄ"));
          return card(s.label, s.desc, wrapper);
        }

        items.forEach((it) => {
          const title = `${it.ord}. ${it.title}`;
          const url = it.post_url || (it.message_id ? `https://t.me/${it.message_id}` : "");
          wrapper.appendChild(itemRow({
            title,
            meta: "–û—Ç–∫—Ä–æ–µ—Ç—Å—è –ø–æ—Å—Ç –≤ –∫–∞–Ω–∞–ª–µ",
            url,
            rightLabel: "–û—Ç–∫—Ä—ã—Ç—å –ø–æ—Å—Ç"
          }));
        });

        return card(s.label, s.desc, wrapper);
      }

      async function renderLinks() {
        const s = sections.find(x => x.key === "links");
        const wrapper = document.createElement("div");
        wrapper.className = "list";

        const { data } = await apiGet("/links");
        const items = Array.isArray(data?.items) ? data.items : [];

        if (!items.length) {
          wrapper.appendChild(emptyBlock("–ü–æ–∫–∞ –Ω–µ—Ç —Å—Å—ã–ª–æ–∫. –ê–¥–º–∏–Ω –¥–æ–±–∞–≤–∏—Ç ‚Äî –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å."));
          return card(s.label, s.desc, wrapper);
        }

        items.forEach((it) => {
          wrapper.appendChild(itemRow({
            title: it.title || it.url,
            meta: it.url,
            url: it.url,
            rightLabel: "–û—Ç–∫—Ä—ã—Ç—å"
          }));
        });

        return card(s.label, s.desc, wrapper);
      }

      async function renderNews() {
        const s = sections.find(x => x.key === "news");
        const wrapper = document.createElement("div");
        wrapper.className = "list";

        const { data } = await apiGet("/news");
        const items = Array.isArray(data?.items) ? data.items : [];

        if (!items.length) {
          wrapper.appendChild(emptyBlock("–ü–æ–∫–∞ –Ω–µ—Ç –Ω–æ–≤–æ—Å—Ç–µ–π. –ê–¥–º–∏–Ω –¥–æ–±–∞–≤–∏—Ç ‚Äî –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å."));
          return card(s.label, s.desc, wrapper);
        }

        items.forEach((it, idx) => {
          const title = `–ù–æ–≤–æ—Å—Ç—å ${idx + 1}`;
          const meta = it.created_at ? `–î–æ–±–∞–≤–ª–µ–Ω–æ: ${it.created_at}` : "";
          const url = it.post_url || "";
          wrapper.appendChild(itemRow({
            title,
            meta,
            url,
            rightLabel: "–û—Ç–∫—Ä—ã—Ç—å –ø–æ—Å—Ç"
          }));
        });

        return card(s.label, s.desc, wrapper);
      }

      async function renderSection(key) {
        const sec = sections.find(x => x.key === key) || sections[0];
        titleEl.textContent = sec.label;

        contentEl.innerHTML = "";
        setHash(key);

        // always show side info
        sideInfoEl.textContent =
          `API_BASE: ${API_BASE}\n` +
          (window.Telegram?.WebApp ? "–û—Ç–∫—Ä—ã—Ç–æ –≤–Ω—É—Ç—Ä–∏ Telegram ‚úÖ" : "–û—Ç–∫—Ä—ã—Ç–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä)");

        const apiOk = await markApiStatus();
        if (!apiOk) {
          const body = document.createElement("div");
          body.className = "list";
          body.appendChild(emptyBlock("API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ù–∞–∂–º–∏ ¬´‚Üª –û–±–Ω–æ–≤–∏—Ç—å¬ª –∏–ª–∏ –æ—Ç–∫—Ä–æ–π –ø–æ–∑–∂–µ."));
          const errCard = card("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è", "–°–µ—Ä–≤–∏—Å API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç.", body);
          contentEl.appendChild(errCard);
          return;
        }

        // main content
        try {
          if (key === "prep" || key === "steam") {
            const c = await renderLessons(key);
            contentEl.appendChild(c);

            // –º–∞–ª–µ–Ω—å–∫–∞—è ‚Äú–∑–∞–≥–ª—É—à–∫–∞‚Äù –ø–æ–¥ –±—É–¥—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å
            const b = document.createElement("div");
            b.className = "list";
            b.appendChild(emptyBlock("–°–∫–æ—Ä–æ —Ç—É—Ç –ø–æ—è–≤–∏—Ç—Å—è –∫–Ω–æ–ø–∫–∞ ¬´–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ¬ª –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."));
            contentEl.appendChild(card("–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å", "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä–æ–µ–º —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫.", b));
            return;
          }

          if (key === "links") {
            contentEl.appendChild(await renderLinks());
            return;
          }

          if (key === "news") {
            contentEl.appendChild(await renderNews());
            return;
          }
        } catch (e) {
          apiPillEl.textContent = "API: ERROR";
          apiPillEl.classList.remove("ok", "warn");
          apiPillEl.classList.add("bad");

          const body = document.createElement("div");
          body.className = "list";
          body.appendChild(emptyBlock("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ù–∞–∂–º–∏ ¬´‚Üª –û–±–Ω–æ–≤–∏—Ç—å¬ª."));
          const pre = document.createElement("pre");
          pre.style.margin = "10px 0 0";
          pre.style.padding = "10px";
          pre.style.borderRadius = "12px";
          pre.style.background = "rgba(0,0,0,.25)";
          pre.style.border = "1px solid rgba(255,255,255,.08)";
          pre.style.overflow = "auto";
          pre.style.color = "#dbe6ff";
          pre.style.fontSize = "12px";
          pre.textContent = safeJson({ message: e?.message, url: e?.url, data: e?.data });
          body.appendChild(pre);

          contentEl.appendChild(card("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏", "–î–∞–Ω–Ω—ã–µ —Å API –Ω–µ –ø—Ä–∏—à–ª–∏.", body));
        }
      }

      // Init
      telegramInit();
      renderNav();

      reloadBtn.onclick = () => {
        const current = getInitialSection();
        setActive(current);
        renderSection(current);
      };

      const initial = getInitialSection();
      setActive(initial);
      renderSection(initial);
    </script>
  </body>
</html>
