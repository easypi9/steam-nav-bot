<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>STEAM –ù–∞–≤–∏–≥–∞—Ü–∏—è</title>
    <style>
      :root { --bg:#0b1220; --panel:#111a2e; --card:#0f1930; --text:#e8eefc; --muted:#a9b7db; --accent:#6aa7ff; --ok:#38d39f; --bad:#ff6a6a; }
      * { box-sizing: border-box; }
      body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); }
      .app { display:flex; min-height:100vh; }
      .sidebar { width: 280px; background:var(--panel); padding:16px; border-right: 1px solid rgba(255,255,255,.08); }
      .brand { font-weight:700; letter-spacing:.2px; margin-bottom:14px; }
      .sub { color:var(--muted); font-size:13px; margin-bottom:14px; line-height:1.35; }
      .nav { display:flex; flex-direction:column; gap:8px; }
      .btn {
        width:100%; text-align:left; padding:12px 12px; border-radius:12px;
        border: 1px solid rgba(255,255,255,.10);
        background: rgba(255,255,255,.04); color:var(--text); cursor:pointer;
        display:flex; justify-content:space-between; align-items:center;
      }
      .btn:hover { border-color: rgba(106,167,255,.45); }
      .btn.active { outline: 2px solid rgba(106,167,255,.55); background: rgba(106,167,255,.10); }
      .tag { font-size:12px; color:var(--muted); }
      .main { flex:1; padding:18px; }
      .top { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:14px; }
      .title { font-size:18px; font-weight:700; }
      .right { display:flex; gap:10px; align-items:center; }
      .pill {
        padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12);
        color:var(--muted); font-size:12px;
      }
      .pill.ok { border-color: rgba(56,211,159,.35); color: var(--ok); }
      .pill.bad { border-color: rgba(255,106,106,.35); color: var(--bad); }
      .linkbtn{
        padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12);
        background: rgba(255,255,255,.04); color:var(--text); cursor:pointer; font-size:12px;
      }
      .linkbtn:hover{ border-color: rgba(106,167,255,.45); }
      .card {
        background: var(--card);
        border: 1px solid rgba(255,255,255,.10);
        border-radius:16px;
        padding:14px;
      }
      .cards { display:grid; grid-template-columns: 1fr; gap:12px; }
      .row { display:flex; gap:10px; align-items:center; justify-content:space-between; }
      .muted { color:var(--muted); font-size:13px; line-height:1.45; }
      a { color: var(--accent); text-decoration: none; font-weight: 600; }
      a:hover { text-decoration: underline; }
      pre {
        margin: 10px 0 0;
        padding: 10px;
        border-radius: 12px;
        background: rgba(0,0,0,.25);
        overflow:auto;
        border:1px solid rgba(255,255,255,.08);
        color: #dbe6ff;
        font-size: 12px;
      }
      .small { font-size:12px; color:var(--muted); margin-top:10px; white-space:pre-line; }
      ul { margin: 8px 0 0 18px; padding: 0; }
      li { margin: 6px 0; }

      .lessonLink {
        display:inline-flex;
        gap:8px;
        align-items:center;
        cursor:pointer;
      }

      @media (max-width: 820px) { .sidebar { width: 220px; } }
      @media (max-width: 650px) {
        .app { flex-direction: column; }
        .sidebar { width:100%; border-right:none; border-bottom: 1px solid rgba(255,255,255,.08); }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <aside class="sidebar">
        <div class="brand">üìö STEAM –ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
        <div class="sub">–ú–µ–Ω—é + –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API (Railway). –ï—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî —É–≤–∏–¥–∏—à—å –æ—à–∏–±–∫—É —Å–≤–µ—Ä—Ö—É.</div>

        <nav class="nav" id="nav"></nav>

        <div class="small" id="sideInfo"></div>
      </aside>

      <main class="main">
        <div class="top">
          <div class="title" id="screenTitle">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
          <div class="right">
            <button class="linkbtn" id="reloadBtn">‚Üª –û–±–Ω–æ–≤–∏—Ç—å</button>
            <div class="pill" id="tgPill">browser preview</div>
            <div class="pill" id="apiPill">API: ...</div>
          </div>
        </div>

        <div class="cards" id="content"></div>
      </main>
    </div>

    <script>
      // ====== CONFIG ======
      // –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å API —á–µ—Ä–µ–∑ ?api=https://....
      const qs = new URLSearchParams(location.search);
      const API_BASE =
        (qs.get("api") || "").trim() ||
        (localStorage.getItem("API_BASE") || "").trim() ||
        "https://steam-nav-bot-production.up.railway.app";

      // –ß—Ç–æ–±—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤–æ–µ –±–µ–∑ –∫—ç—à–∞: –¥–æ–±–∞–≤–ª—è–π ?v=13 (–ª—é–±–æ–π –Ω–æ–º–µ—Ä)
      const NO_CACHE = { cache: "no-store" };

      const sections = [
        { key: "prep", label: "üß© –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã–π –∫—É—Ä—Å", desc: "–£—Ä–æ–∫–∏ —Å –Ω—É–ª—è: –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ STEAM." },
        { key: "steam", label: "üöÄ –ö—É—Ä—Å STEAM", desc: "–û—Å–Ω–æ–≤–Ω–æ–π –∫—É—Ä—Å, –º–æ–¥—É–ª–∏ –∏ –ø—Ä–∞–∫—Ç–∏–∫–∞." },
        { key: "news", label: "üóû –ù–æ–≤–æ—Å—Ç–∏", desc: "–ê–Ω–æ–Ω—Å—ã, –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, —Å–æ–±—ã—Ç–∏—è." },
        { key: "links", label: "üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏", desc: "–†–µ—Å—É—Ä—Å—ã, —Å–µ—Ä–≤–∏—Å—ã, –º–∞—Ç–µ—Ä–∏–∞–ª—ã." },
      ];

      const navEl = document.getElementById("nav");
      const contentEl = document.getElementById("content");
      const titleEl = document.getElementById("screenTitle");
      const tgPillEl = document.getElementById("tgPill");
      const apiPillEl = document.getElementById("apiPill");
      const sideInfoEl = document.getElementById("sideInfo");
      const reloadBtn = document.getElementById("reloadBtn");

      function setActive(key) {
        document.querySelectorAll(".btn").forEach(b => b.classList.toggle("active", b.dataset.key === key));
      }

      function safeJsonString(obj) {
        try { return JSON.stringify(obj, null, 2); } catch { return String(obj); }
      }

      function card(title, bodyHtml) {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <div class="row"><div style="font-weight:700">${title}</div></div>
          <div class="muted" style="margin-top:8px">${bodyHtml}</div>
        `;
        return div;
      }

      async function apiGet(path) {
        const url = API_BASE.replace(/\/$/, "") + path;
        const res = await fetch(url, NO_CACHE);
        const txt = await res.text();
        let data;
        try { data = JSON.parse(txt); } catch { data = { raw: txt }; }
        if (!res.ok) {
          const err = new Error(`HTTP ${res.status}`);
          err.data = data;
          err.url = url;
          throw err;
        }
        return { url, data };
      }

      // ====== TELEGRAM USER ID ======
      function getTelegramUserId() {
        try {
          return window.Telegram?.WebApp?.initDataUnsafe?.user?.id || null;
        } catch {
          return null;
        }
      }

      // ====== SAVE PROGRESS ======
      async function saveProgress(section, ord) {
        const user_id = getTelegramUserId();
        // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –Ω–µ –≤ Telegram ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
        if (!user_id) return { ok: false, reason: "no-telegram-user" };

        try {
          const url = API_BASE.replace(/\/$/, "") + "/progress";
          const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_id, section, ord }),
          });
          if (!res.ok) return { ok: false, reason: "http-" + res.status };
          return { ok: true };
        } catch (e) {
          return { ok: false, reason: "network" };
        }
      }

      async function loadMetaAndMarkApi() {
        try {
          const { data } = await apiGet("/meta");
          apiPillEl.textContent = "API: OK";
          apiPillEl.classList.remove("bad");
          apiPillEl.classList.add("ok");

          const uid = getTelegramUserId();
          sideInfoEl.textContent =
            `–û—Ç–∫—Ä—ã—Ç–æ: ${window.Telegram?.WebApp ? "Telegram ‚úÖ" : "–±—Ä–∞—É–∑–µ—Ä (–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä)"}\n` +
            `API_BASE: ${API_BASE}\n` +
            `user_id: ${uid || "–Ω–µ—Ç (–Ω–µ Telegram)"}`;

          return data;
        } catch (e) {
          apiPillEl.textContent = "API: ERROR";
          apiPillEl.classList.remove("ok");
          apiPillEl.classList.add("bad");

          const uid = getTelegramUserId();
          sideInfoEl.textContent =
            `–û—Ç–∫—Ä—ã—Ç–æ: ${window.Telegram?.WebApp ? "Telegram ‚úÖ" : "–±—Ä–∞—É–∑–µ—Ä (–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä)"}\n` +
            `API_BASE: ${API_BASE}\n` +
            `user_id: ${uid || "–Ω–µ—Ç (–Ω–µ Telegram)"}`;

          throw e;
        }
      }

      async function renderSection(key) {
        const s = sections.find(x => x.key === key) || sections[0];
        titleEl.textContent = s.label;

        contentEl.innerHTML = "";

        try {
          const meta = await loadMetaAndMarkApi();

          // META
          contentEl.appendChild(card("–°–≤—è–∑—å —Å API ‚úÖ", `META –∏–∑ API:<pre>${safeJsonString(meta)}</pre>`));

          // ===== LESSONS =====
          if (key === "prep" || key === "steam") {
            const { data, url } = await apiGet(`/lessons?section=${encodeURIComponent(key)}`);
            const items = Array.isArray(data?.items) ? data.items : [];

            const debug = `<div>GET: <a href="${url}" target="_blank" rel="noreferrer">${url}</a></div><pre>${safeJsonString(data)}</pre>`;
            contentEl.appendChild(card("–û—Ç–≤–µ—Ç /lessons (debug)", debug));

            if (!items.length) {
              contentEl.appendChild(card("–°–ø–∏—Å–æ–∫ —É—Ä–æ–∫–æ–≤ (–∏–∑ API)", `–£—Ä–æ–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.`));
            } else {
              const list = document.createElement("div");
              list.className = "card";
              list.innerHTML = `
                <div class="row"><div style="font-weight:700">–°–ø–∏—Å–æ–∫ —É—Ä–æ–∫–æ–≤ (–∏–∑ API)</div></div>
                <ul id="lessonList"></ul>
                <div class="small">–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date().toLocaleString()}</div>
              `;
              contentEl.appendChild(list);

              const ul = list.querySelector("#lessonList");

              items.forEach((it) => {
                const li = document.createElement("li");

                const post = it.post_url || "";
                const label = `${it.ord}. ${it.title}`;

                if (!post) {
                  li.textContent = label;
                } else {
                  // —Å–æ–∑–¥–∞—ë–º –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                  const a = document.createElement("a");
                  a.href = post;
                  a.target = "_blank";
                  a.rel = "noreferrer";
                  a.className = "lessonLink";
                  a.textContent = "–æ—Ç–∫—Ä—ã—Ç—å –ø–æ—Å—Ç";

                  // –ø–µ—Ä–µ—Ö–≤–∞—Ç –∫–ª–∏–∫–∞: —Å–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å, –∑–∞—Ç–µ–º –æ—Ç–∫—Ä—ã–≤–∞–µ–º
                  a.addEventListener("click", async (ev) => {
                    // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∂–∞–ª cmd/ctrl/–æ—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ ‚Äî –Ω–µ –º–µ—à–∞–µ–º
                    if (ev.metaKey || ev.ctrlKey || ev.shiftKey || ev.altKey) return;

                    ev.preventDefault();
                    await saveProgress(key, Number(it.ord));
                    window.open(post, "_blank", "noopener,noreferrer");
                  });

                  li.innerHTML = `${label} ‚Äî `;
                  li.appendChild(a);
                }

                ul.appendChild(li);
              });
            }
          }

          // ===== LINKS =====
          if (key === "links") {
            const { data, url } = await apiGet("/links");
            const items = Array.isArray(data?.items) ? data.items : [];

            contentEl.appendChild(card("–û—Ç–≤–µ—Ç /links (debug)", `<div>GET: <a href="${url}" target="_blank" rel="noreferrer">${url}</a></div><pre>${safeJsonString(data)}</pre>`));

            if (!items.length) {
              contentEl.appendChild(card("–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏", "–°—Å—ã–ª–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç."));
            } else {
              const ul = document.createElement("ul");
              items.forEach((it) => {
                const li = document.createElement("li");
                li.innerHTML = `<a href="${it.url}" target="_blank" rel="noreferrer">${it.title}</a>`;
                ul.appendChild(li);
              });
              const wrap = document.createElement("div");
              wrap.className = "card";
              wrap.innerHTML = `<div class="row"><div style="font-weight:700">–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏</div></div>`;
              wrap.appendChild(ul);
              contentEl.appendChild(wrap);
            }
          }

          // ===== NEWS =====
          if (key === "news") {
            const { data, url } = await apiGet("/news");
            const items = Array.isArray(data?.items) ? data.items : [];

            contentEl.appendChild(card("–û—Ç–≤–µ—Ç /news (debug)", `<div>GET: <a href="${url}" target="_blank" rel="noreferrer">${url}</a></div><pre>${safeJsonString(data)}</pre>`));

            if (!items.length) {
              contentEl.appendChild(card("–ù–æ–≤–æ—Å—Ç–∏", "–ù–æ–≤–æ—Å—Ç–µ–π –ø–æ–∫–∞ –Ω–µ—Ç."));
            } else {
              const ul = document.createElement("ul");
              items.forEach((it) => {
                const post = it.post_url || "";
                const li = document.createElement("li");
                li.innerHTML = post
                  ? `<a href="${post}" target="_blank" rel="noreferrer">${it.message_id}</a> <span class="muted">(${it.created_at})</span>`
                  : `${it.message_id} <span class="muted">(${it.created_at})</span>`;
                ul.appendChild(li);
              });
              const wrap = document.createElement("div");
              wrap.className = "card";
              wrap.innerHTML = `<div class="row"><div style="font-weight:700">–ù–æ–≤–æ—Å—Ç–∏</div></div>`;
              wrap.appendChild(ul);
              contentEl.appendChild(wrap);
            }
          }

          // hash
          location.hash = key;

        } catch (e) {
          apiPillEl.textContent = "API: ERROR";
          apiPillEl.classList.remove("ok");
          apiPillEl.classList.add("bad");

          const msg = `
            <div>–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å API.</div>
            <div class="small">API_BASE: ${API_BASE}</div>
            <pre>${safeJsonString({ message: e?.message, url: e?.url, data: e?.data })}</pre>
          `;
          contentEl.appendChild(card("–û—à–∏–±–∫–∞ API ‚ùå", msg));
        }
      }

      function renderNav() {
        navEl.innerHTML = "";
        sections.forEach(s => {
          const btn = document.createElement("button");
          btn.className = "btn";
          btn.dataset.key = s.key;
          btn.innerHTML = `<span>${s.label}</span><span class="tag">—Ä–∞–∑–¥–µ–ª</span>`;
          btn.onclick = () => { setActive(s.key); renderSection(s.key); };
          navEl.appendChild(btn);
        });
      }

      // Telegram awareness
      const tg = window.Telegram?.WebApp;
      if (tg) {
        tgPillEl.textContent = "telegram webapp";
        try { tg.expand(); } catch {}
      } else {
        tgPillEl.textContent = "browser preview";
      }

      reloadBtn.onclick = () => {
        const current = (location.hash || "#prep").replace("#", "");
        renderSection(current);
      };

      renderNav();
      const initial = (location.hash || "#prep").replace("#", "");
      setActive(initial);
      renderSection(initial);
    </script>
  </body>
</html>
