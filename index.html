<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>STEAM –ù–∞–≤–∏–≥–∞—Ü–∏—è</title>
    <style>
      :root { --bg:#0b1220; --panel:#111a2e; --card:#0f1930; --text:#e8eefc; --muted:#a9b7db; --accent:#6aa7ff; --bad:#ff6a6a; --ok:#58d18c; }
      * { box-sizing: border-box; }
      body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); }
      .app { display:flex; min-height:100vh; }
      .sidebar { width: 280px; background:var(--panel); padding:16px; border-right: 1px solid rgba(255,255,255,.08); }
      .brand { font-weight:700; letter-spacing:.2px; margin-bottom:14px; }
      .sub { color:var(--muted); font-size:13px; margin-bottom:14px; line-height:1.35; }
      .nav { display:flex; flex-direction:column; gap:8px; }
      .btn {
        width:100%; text-align:left; padding:12px 12px; border-radius:12px;
        border: 1px solid rgba(255,255,255,.10);
        background: rgba(255,255,255,.04); color:var(--text); cursor:pointer;
        display:flex; justify-content:space-between; align-items:center;
      }
      .btn:hover { border-color: rgba(106,167,255,.45); }
      .btn.active { outline: 2px solid rgba(106,167,255,.55); background: rgba(106,167,255,.10); }
      .tag { font-size:12px; color:var(--muted); }
      .main { flex:1; padding:18px; }
      .top { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:14px; }
      .title { font-size:18px; font-weight:700; }

      .badges { display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
      .pill { padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); color:var(--muted); font-size:12px; }
      .pill.ok { border-color: rgba(88,209,140,.45); color: var(--ok); }
      .pill.bad { border-color: rgba(255,106,106,.45); color: var(--bad); }

      .card {
        background: var(--card);
        border: 1px solid rgba(255,255,255,.10);
        border-radius:16px;
        padding:14px;
      }
      .cards { display:grid; grid-template-columns: 1fr; gap:12px; }
      .row { display:flex; gap:10px; align-items:center; justify-content:space-between; }
      .muted { color:var(--muted); font-size:13px; line-height:1.45; }
      .link {
        display:inline-flex; gap:8px; align-items:center;
        text-decoration:none; color:var(--accent); font-weight:600;
      }
      .small { font-size:12px; color:var(--muted); margin-top:8px; }

      .list { display:flex; flex-direction:column; gap:10px; margin-top:10px; }
      .item { padding:12px; border-radius:14px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.03); }
      .itemTitle { font-weight:700; margin-bottom:6px; }
      .itemMeta { color:var(--muted); font-size:12px; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

      @media (max-width: 820px) { .sidebar { width: 220px; } }
      @media (max-width: 650px) {
        .app { flex-direction: column; }
        .sidebar { width:100%; border-right:none; border-bottom: 1px solid rgba(255,255,255,.08); }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <aside class="sidebar">
        <div class="brand">üìö STEAM –ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
        <div class="sub">–ú–µ–Ω—é + –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API (Railway). –ï—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî —É–≤–∏–¥–∏—à—å –æ—à–∏–±–∫—É —Å–≤–µ—Ä—Ö—É.</div>

        <nav class="nav" id="nav"></nav>

        <div class="small" id="tgHint"></div>
        <div class="small mono" id="apiHint" style="margin-top:10px;"></div>
      </aside>

      <main class="main">
        <div class="top">
          <div class="title" id="screenTitle">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>

          <div class="badges">
            <div class="pill" id="pillEnv">...</div>
            <div class="pill" id="pillApi">API: ...</div>
          </div>
        </div>

        <div class="cards" id="content"></div>
      </main>
    </div>

    <script>
      // ====== CONFIG ======
      // 1) –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å API —á–µ—Ä–µ–∑ query: ?api=https://...
      // 2) –ò–Ω–∞—á–µ –±–µ—Ä—ë–º –¥–µ—Ñ–æ–ª—Ç (—Ç–≤–æ—è Railway —Å—Å—ã–ª–∫–∞)
      const DEFAULT_API_BASE = "https://steam-nav-bot-production.up.railway.app";

      function getQueryParam(name) {
        const u = new URL(location.href);
        return u.searchParams.get(name);
      }

      const apiFromQuery = (getQueryParam("api") || "").trim();
      const API_BASE = apiFromQuery || DEFAULT_API_BASE;

      // ====== UI DATA ======
      const sections = [
        { key: "prep",  label: "üß© –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã–π –∫—É—Ä—Å", desc: "–£—Ä–æ–∫–∏ —Å –Ω—É–ª—è: –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ STEAM." },
        { key: "steam", label: "üöÄ –ö—É—Ä—Å STEAM",           desc: "–û—Å–Ω–æ–≤–Ω–æ–π –∫—É—Ä—Å, –º–æ–¥—É–ª–∏ –∏ –ø—Ä–∞–∫—Ç–∏–∫–∞." },
        { key: "news",  label: "üóû –ù–æ–≤–æ—Å—Ç–∏",              desc: "–ê–Ω–æ–Ω—Å—ã, –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, —Å–æ–±—ã—Ç–∏—è." },
        { key: "links", label: "üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏",      desc: "–†–µ—Å—É—Ä—Å—ã, —Å–µ—Ä–≤–∏—Å—ã, –º–∞—Ç–µ—Ä–∏–∞–ª—ã." },
      ];

      // ====== DOM ======
      const navEl = document.getElementById("nav");
      const contentEl = document.getElementById("content");
      const titleEl = document.getElementById("screenTitle");
      const pillEnvEl = document.getElementById("pillEnv");
      const pillApiEl = document.getElementById("pillApi");
      const tgHintEl = document.getElementById("tgHint");
      const apiHintEl = document.getElementById("apiHint");

      // ====== HELPERS ======
      function setActive(key) {
        document.querySelectorAll(".btn").forEach(b => b.classList.toggle("active", b.dataset.key === key));
      }

      function card(title, bodyHtml) {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <div class="row">
            <div style="font-weight:700">${title}</div>
          </div>
          <div class="muted" style="margin-top:8px;">${bodyHtml}</div>
        `;
        return div;
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      async function apiGet(path) {
        const url = API_BASE.replace(/\/$/, "") + path;
        const r = await fetch(url, { method: "GET" });
        if (!r.ok) {
          const txt = await r.text().catch(() => "");
          throw new Error(`HTTP ${r.status} ${r.statusText} ‚Äî ${txt.slice(0, 200)}`);
        }
        return r.json();
      }

      // ====== TELEGRAM AWARENESS ======
      const tg = window.Telegram?.WebApp;
      if (tg) {
        pillEnvEl.textContent = "telegram webapp";
        tgHintEl.textContent = "–û—Ç–∫—Ä—ã—Ç–æ –≤–Ω—É—Ç—Ä–∏ Telegram ‚úÖ";
        try { tg.expand(); } catch {}
      } else {
        pillEnvEl.textContent = "browser preview";
        tgHintEl.textContent = "–û—Ç–∫—Ä—ã—Ç–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä).";
      }

      apiHintEl.textContent = `API_BASE: ${API_BASE}`;

      // ====== API STATUS (meta) ======
      async function loadApiStatus() {
        pillApiEl.textContent = "API: checking‚Ä¶";
        pillApiEl.classList.remove("ok", "bad");

        try {
          const meta = await apiGet("/meta");
          pillApiEl.textContent = "API: OK";
          pillApiEl.classList.add("ok");
          return meta;
        } catch (e) {
          pillApiEl.textContent = "API: ERROR";
          pillApiEl.classList.add("bad");
          return { error: String(e?.message || e) };
        }
      }

      // ====== RENDER ======
      function renderNav() {
        navEl.innerHTML = "";
        sections.forEach(s => {
          const btn = document.createElement("button");
          btn.className = "btn";
          btn.dataset.key = s.key;
          btn.innerHTML = `<span>${s.label}</span><span class="tag">—Ä–∞–∑–¥–µ–ª</span>`;
          btn.onclick = () => { setActive(s.key); renderSection(s.key); };
          navEl.appendChild(btn);
        });
      }

      async function renderSection(key) {
        const s = sections.find(x => x.key === key) || sections[0];
        titleEl.textContent = s.label;
        contentEl.innerHTML = "";
        location.hash = key;

        // –ü–µ—Ä–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ API
        const meta = await loadApiStatus();

        if (meta && meta.error) {
          contentEl.appendChild(card("–°–≤—è–∑—å —Å API ‚ùå", `
            <div class="mono">${escapeHtml(meta.error)}</div>
            <div style="margin-top:10px" class="muted">
              –ü—Ä–æ–≤–µ—Ä—å:<br/>
              ‚Ä¢ Railway URL –¥–æ—Å—Ç—É–ø–µ–Ω: <span class="mono">${escapeHtml(API_BASE)}</span><br/>
              ‚Ä¢ CORS: Origin –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å <span class="mono">https://easypi9.github.io</span><br/>
              ‚Ä¢ /health –∏ /meta –¥–æ–ª–∂–Ω—ã –æ—Ç–¥–∞–≤–∞—Ç—å 200
            </div>
          `));
          contentEl.appendChild(card("–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞ ‚úÖ", `
            API —Å–µ–π—á–∞—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–æ WebApp —É–∂–µ —É–º–µ–µ—Ç –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è.
          `));
          return;
        }

        contentEl.appendChild(card("–°–≤—è–∑—å —Å API ‚úÖ", `
          <div class="muted">META –∏–∑ API:</div>
          <div class="mono" style="white-space:pre-wrap; margin-top:8px;">${escapeHtml(JSON.stringify(meta, null, 2))}</div>
        `));

        // –î–∞–ª–µ–µ ‚Äî –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º
        try {
          if (key === "prep" || key === "steam") {
            const data = await apiGet(`/lessons?section=${encodeURIComponent(key)}`);
            const items = Array.isArray(data.items) ? data.items : [];
            const list = document.createElement("div");
            list.className = "list";

            if (!items.length) {
              list.appendChild(card("–£—Ä–æ–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç", "–î–æ–±–∞–≤—å –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü—É lessons (SQLite), –∏ –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è —Ç—É—Ç."));
            } else {
              items.forEach(it => {
                const el = document.createElement("div");
                el.className = "item";
                const post = it.post_url ? `<a class="link" href="${it.post_url}" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å –ø–æ—Å—Ç</a>` : "";
                el.innerHTML = `
                  <div class="itemTitle">${escapeHtml(it.ord)}. ${escapeHtml(it.title)}</div>
                  <div class="itemMeta mono">message_id: ${escapeHtml(it.message_id)}</div>
                  <div style="margin-top:8px">${post}</div>
                `;
                list.appendChild(el);
              });
            }

            contentEl.appendChild(card("–°–ø–∏—Å–æ–∫ —É—Ä–æ–∫–æ–≤ (–∏–∑ API)", `<div id="listMount"></div>`));
            contentEl.lastChild.querySelector("#listMount").appendChild(list);
          }

          if (key === "links") {
            const data = await apiGet("/links");
            const items = Array.isArray(data.items) ? data.items : [];
            const list = document.createElement("div");
            list.className = "list";

            if (!items.length) {
              list.appendChild(card("–°—Å—ã–ª–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç", "–î–æ–±–∞–≤—å –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü—É links (SQLite), –∏ –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è —Ç—É—Ç."));
            } else {
              items.forEach(it => {
                const el = document.createElement("div");
                el.className = "item";
                el.innerHTML = `
                  <div class="itemTitle">${escapeHtml(it.title)}</div>
                  <div style="margin-top:8px">
                    <a class="link" href="${it.url}" target="_blank" rel="noopener">${escapeHtml(it.url)}</a>
                  </div>
                `;
                list.appendChild(el);
              });
            }

            contentEl.appendChild(card("–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏ (–∏–∑ API)", `<div id="listMount"></div>`));
            contentEl.lastChild.querySelector("#listMount").appendChild(list);
          }

          if (key === "news") {
            const data = await apiGet("/news");
            const items = Array.isArray(data.items) ? data.items : [];
            const list = document.createElement("div");
            list.className = "list";

            if (!items.length) {
              list.appendChild(card("–ù–æ–≤–æ—Å—Ç–µ–π –ø–æ–∫–∞ –Ω–µ—Ç", "–î–æ–±–∞–≤—å –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü—É news (SQLite), –∏ –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è —Ç—É—Ç."));
            } else {
              items.forEach(it => {
                const el = document.createElement("div");
                el.className = "item";
                const post = it.post_url ? `<a class="link" href="${it.post_url}" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å –ø–æ—Å—Ç</a>` : "";
                el.innerHTML = `
                  <div class="itemTitle">–ü–æ—Å—Ç: ${escapeHtml(it.message_id)}</div>
                  <div class="itemMeta mono">created_at: ${escapeHtml(it.created_at || "")}</div>
                  <div style="margin-top:8px">${post}</div>
                `;
                list.appendChild(el);
              });
            }

            contentEl.appendChild(card("–ù–æ–≤–æ—Å—Ç–∏ (–∏–∑ API)", `<div id="listMount"></div>`));
            contentEl.lastChild.querySelector("#listMount").appendChild(list);
          }

        } catch (e) {
          contentEl.appendChild(card("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö ‚ùå", `
            <div class="mono">${escapeHtml(e?.message || String(e))}</div>
          `));
        }

        contentEl.appendChild(card("–ü–æ–¥—Å–∫–∞–∑–∫–∞", `
          –ï—Å–ª–∏ —Ç—ã –≤–∏–¥–∏—à—å "API: OK" —Å–≤–µ—Ä—Ö—É ‚Äî –∑–Ω–∞—á–∏—Ç WebApp —Ä–µ–∞–ª—å–Ω–æ —Ö–æ–¥–∏—Ç –≤ Railway.<br/>
          –ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –≤–∏–¥–Ω—ã ‚Äî –æ—Ç–∫—Ä–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º <span class="mono">?v=2</span> –∏–ª–∏ —Å–¥–µ–ª–∞–π –∂—ë—Å—Ç–∫—É—é –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É.
        `));
      }

      // ====== START ======
      renderNav();
      const initial = (location.hash || "#prep").replace("#", "");
      setActive(initial);
      renderSection(initial);
    </script>
  </body>
</html>
