<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>STEAM –ù–∞–≤–∏–≥–∞—Ü–∏—è</title>
    <style>
      :root {
        --bg:#0b1220; --panel:#111a2e; --card:#0f1930;
        --text:#e8eefc; --muted:#a9b7db; --accent:#6aa7ff;
        --ok:#38d39f; --bad:#ff6a6a; --warn:#ffd36a;
      }
      * { box-sizing: border-box; }
      body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); }
      .app { display:flex; min-height:100vh; }
      .sidebar { width: 280px; background:var(--panel); padding:16px; border-right: 1px solid rgba(255,255,255,.08); }
      .brand { font-weight:700; letter-spacing:.2px; margin-bottom:10px; }
      .sub { color:var(--muted); font-size:13px; margin-bottom:14px; line-height:1.35; }
      .nav { display:flex; flex-direction:column; gap:8px; }
      .btn {
        width:100%; text-align:left; padding:12px 12px; border-radius:12px;
        border: 1px solid rgba(255,255,255,.10);
        background: rgba(255,255,255,.04); color:var(--text); cursor:pointer;
        display:flex; justify-content:space-between; align-items:center;
      }
      .btn:hover { border-color: rgba(106,167,255,.45); }
      .btn.active { outline: 2px solid rgba(106,167,255,.55); background: rgba(106,167,255,.10); }
      .tag { font-size:12px; color:var(--muted); }

      .main { flex:1; padding:18px; }
      .top { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:14px; }
      .title { font-size:18px; font-weight:700; }

      .right { display:flex; gap:10px; align-items:center; flex-wrap: wrap; justify-content:flex-end; }
      .pill {
        padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12);
        color:var(--muted); font-size:12px;
      }
      .pill.ok { border-color: rgba(56,211,159,.35); color: var(--ok); }
      .pill.bad { border-color: rgba(255,106,106,.35); color: var(--bad); }
      .pill.warn { border-color: rgba(255,211,106,.35); color: var(--warn); }

      .linkbtn{
        padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12);
        background: rgba(255,255,255,.04); color:var(--text); cursor:pointer; font-size:12px;
      }
      .linkbtn:hover{ border-color: rgba(106,167,255,.45); }

      .card {
        background: var(--card);
        border: 1px solid rgba(255,255,255,.10);
        border-radius:16px;
        padding:14px;
      }
      .cards { display:grid; grid-template-columns: 1fr; gap:12px; }

      .row { display:flex; gap:10px; align-items:center; justify-content:space-between; }
      .muted { color:var(--muted); font-size:13px; line-height:1.45; }

      a { color: var(--accent); text-decoration: none; font-weight: 700; }
      a:hover { text-decoration: underline; }

      .small { font-size:12px; color:var(--muted); margin-top:10px; white-space:pre-line; }

      ul { margin: 8px 0 0 18px; padding: 0; }
      li { margin: 8px 0; }

      .lessonLine {
        display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
        padding:10px 10px; border-radius:12px;
        border:1px solid rgba(255,255,255,.08);
        background: rgba(255,255,255,.03);
      }
      .lessonLine:hover { border-color: rgba(106,167,255,.35); }
      .lessonMain { display:flex; flex-direction:column; gap:4px; }
      .lessonTitle { font-weight:800; }
      .lessonMeta { font-size:12px; color: var(--muted); }

      .chip {
        font-size:12px; padding:6px 10px; border-radius:999px;
        border:1px solid rgba(255,255,255,.12);
        color: var(--muted);
        white-space:nowrap;
      }
      .chip.curr { border-color: rgba(56,211,159,.35); color: var(--ok); }
      .chip.none { border-color: rgba(255,211,106,.35); color: var(--warn); }

      .danger { color: var(--bad); font-weight:700; }

      pre {
        margin: 10px 0 0;
        padding: 10px;
        border-radius: 12px;
        background: rgba(0,0,0,.25);
        overflow:auto;
        border:1px solid rgba(255,255,255,.08);
        color: #dbe6ff;
        font-size: 12px;
        display:none;
      }
      pre.show { display:block; }

      @media (max-width: 820px) { .sidebar { width: 220px; } }
      @media (max-width: 650px) {
        .app { flex-direction: column; }
        .sidebar { width:100%; border-right:none; border-bottom: 1px solid rgba(255,255,255,.08); }
      }
    </style>
  </head>

  <body>
    <div class="app">
      <aside class="sidebar">
        <div class="brand">üìö STEAM –ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
        <div class="sub">–ß–∏—Å—Ç—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–±–µ–∑ JSON –Ω–∞ —ç–∫—Ä–∞–Ω–µ). Debug –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –∫–Ω–æ–ø–∫–æ–π.</div>
        <nav class="nav" id="nav"></nav>
        <div class="small" id="sideInfo"></div>
      </aside>

      <main class="main">
        <div class="top">
          <div class="title" id="screenTitle">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
          <div class="right">
            <button class="linkbtn" id="reloadBtn">‚Üª –û–±–Ω–æ–≤–∏—Ç—å</button>
            <button class="linkbtn" id="debugBtn">Debug: off</button>
            <div class="pill" id="tgPill">browser preview</div>
            <div class="pill" id="apiPill">API: ...</div>
          </div>
        </div>

        <div class="cards" id="content"></div>
      </main>
    </div>

    <script>
      // ====== CONFIG ======
      const qs = new URLSearchParams(location.search);
      const API_BASE =
        (qs.get("api") || "").trim() ||
        (localStorage.getItem("API_BASE") || "").trim() ||
        "https://steam-nav-bot-production.up.railway.app";

      const NO_CACHE = { cache: "no-store" };

      const sections = [
        { key: "prep", label: "üß© –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã–π –∫—É—Ä—Å" },
        { key: "steam", label: "üöÄ –ö—É—Ä—Å STEAM" },
        { key: "news", label: "üóû –ù–æ–≤–æ—Å—Ç–∏" },
        { key: "links", label: "üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏" },
      ];

      const navEl = document.getElementById("nav");
      const contentEl = document.getElementById("content");
      const titleEl = document.getElementById("screenTitle");
      const tgPillEl = document.getElementById("tgPill");
      const apiPillEl = document.getElementById("apiPill");
      const sideInfoEl = document.getElementById("sideInfo");
      const reloadBtn = document.getElementById("reloadBtn");
      const debugBtn = document.getElementById("debugBtn");

      let DEBUG = (qs.get("debug") || "") === "1";

      function setActive(key) {
        document.querySelectorAll(".btn").forEach(b => b.classList.toggle("active", b.dataset.key === key));
      }

      function safeJsonString(obj) {
        try { return JSON.stringify(obj, null, 2); } catch { return String(obj); }
      }

      function card(title, bodyHtml) {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <div class="row"><div style="font-weight:800">${title}</div></div>
          <div class="muted" style="margin-top:8px">${bodyHtml}</div>
        `;
        return div;
      }

      async function apiGet(path) {
        const url = API_BASE.replace(/\/$/, "") + path;
        const res = await fetch(url, NO_CACHE);
        const txt = await res.text();
        let data;
        try { data = JSON.parse(txt); } catch { data = { raw: txt }; }
        if (!res.ok) {
          const err = new Error(`HTTP ${res.status}`);
          err.data = data;
          err.url = url;
          throw err;
        }
        return { url, data };
      }

      function getTelegramUserId() {
        try {
          return window.Telegram?.WebApp?.initDataUnsafe?.user?.id || null;
        } catch {
          return null;
        }
      }

      async function saveProgress(section, ord) {
        const user_id = getTelegramUserId();
        if (!user_id) return { ok:false, reason:"no-telegram-user" };

        try {
          const url = API_BASE.replace(/\/$/, "") + "/progress";
          const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_id, section, ord }),
          });
          if (!res.ok) return { ok:false, reason:"http-" + res.status };
          return { ok:true };
        } catch {
          return { ok:false, reason:"network" };
        }
      }

      async function loadMetaAndMarkApi() {
        const uid = getTelegramUserId();
        sideInfoEl.textContent =
          `–û—Ç–∫—Ä—ã—Ç–æ: ${window.Telegram?.WebApp ? "Telegram ‚úÖ" : "–±—Ä–∞—É–∑–µ—Ä (–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä)"}\n` +
          `API_BASE: ${API_BASE}\n` +
          `user_id: ${uid || "–Ω–µ—Ç (–Ω–µ Telegram)"}`;

        try {
          const { data } = await apiGet("/meta");
          apiPillEl.textContent = "API: OK";
          apiPillEl.classList.remove("bad");
          apiPillEl.classList.add("ok");
          return data;
        } catch (e) {
          apiPillEl.textContent = "API: ERROR";
          apiPillEl.classList.remove("ok");
          apiPillEl.classList.add("bad");
          throw e;
        }
      }

      function debugBlock(title, obj) {
        const pre = document.createElement("pre");
        pre.className = DEBUG ? "show" : "";
        pre.textContent = title + "\n" + safeJsonString(obj);
        return pre;
      }

      async function renderContinueCard() {
        const uid = getTelegramUserId();
        if (!uid) {
          const c = card("‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ", `–û—Ç–∫—Ä–æ–π WebApp –≤–Ω—É—Ç—Ä–∏ Telegram, —á—Ç–æ–±—ã –ø–æ—è–≤–∏–ª—Å—è –ø—Ä–æ–≥—Ä–µ—Å—Å (–Ω—É–∂–µ–Ω user_id).`);
          c.querySelector(".muted").appendChild(debugBlock("DEBUG: user_id missing", { user_id: null }));
          contentEl.appendChild(c);
          return;
        }

        try {
          const { data } = await apiGet(`/progress?user_id=${encodeURIComponent(uid)}`);
          // –æ–∂–∏–¥–∞–µ–º items: [{section, ord, title, post_url...}]
          const items = Array.isArray(data?.items) ? data.items : [];
          const prep = items.find(x => x.section === "prep") || null;
          const steam = items.find(x => x.section === "steam") || null;

          const lines = [];
          if (prep) lines.push(`üß© prep: <b>${prep.ord}</b>${prep.title ? ` ‚Äî ${prep.title}` : ""}`);
          if (steam) lines.push(`üöÄ steam: <b>${steam.ord}</b>${steam.title ? ` ‚Äî ${steam.title}` : ""}`);

          const html = lines.length
            ? `${lines.join("<br>")}<div class="small">–ù–∞–∂–º–∏ –Ω–∞ —É—Ä–æ–∫ ‚Äî –ø—Ä–æ–≥—Ä–µ—Å—Å –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>`
            : `–ü–æ–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –Ω–µ—Ç. –û—Ç–∫—Ä–æ–π –ª—é–±–æ–π —É—Ä–æ–∫ ‚Äî –∏ –º—ã –∑–∞–ø–æ–º–Ω–∏–º, –≥–¥–µ —Ç—ã –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è.`;

          const c = card("‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ", html);
          c.querySelector(".muted").appendChild(debugBlock("DEBUG: /progress response", data));
          contentEl.appendChild(c);
        } catch (e) {
          const c = card("‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ", `<span class="danger">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å.</span>`);
          c.querySelector(".muted").appendChild(debugBlock("DEBUG: /progress error", { message: e?.message, url: e?.url, data: e?.data }));
          contentEl.appendChild(c);
        }
      }

      function lessonRow(sectionKey, it, isCurrent) {
        const wrap = document.createElement("div");
        wrap.className = "lessonLine";

        const left = document.createElement("div");
        left.className = "lessonMain";

        const t = document.createElement("div");
        t.className = "lessonTitle";
        t.textContent = `${it.ord}. ${it.title}`;

        const meta = document.createElement("div");
        meta.className = "lessonMeta";
        meta.textContent = "–û—Ç–∫—Ä–æ–µ—Ç –ø–æ—Å—Ç –≤ –∫–∞–Ω–∞–ª–µ (–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å)";

        left.appendChild(t);
        left.appendChild(meta);

        const right = document.createElement("div");
        right.style.display = "flex";
        right.style.gap = "10px";
        right.style.alignItems = "center";

        const chip = document.createElement("div");
        chip.className = "chip " + (isCurrent ? "curr" : "none");
        chip.textContent = isCurrent ? "—Ç–µ–∫—É—â–∏–π" : "—É—Ä–æ–∫";

        const btn = document.createElement("a");
        btn.href = it.post_url || "#";
        btn.target = "_blank";
        btn.rel = "noreferrer";
        btn.textContent = "–û—Ç–∫—Ä—ã—Ç—å";

        btn.addEventListener("click", async (ev) => {
          // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–ª ‚Äú–æ—Å–æ–±—ã–º‚Äù –∫–ª–∏–∫–æ–º ‚Äî –Ω–µ –º–µ—à–∞–µ–º
          if (ev.metaKey || ev.ctrlKey || ev.shiftKey || ev.altKey) return;

          ev.preventDefault();
          await saveProgress(sectionKey, Number(it.ord));
          if (it.post_url) window.open(it.post_url, "_blank", "noopener,noreferrer");
        });

        right.appendChild(chip);
        right.appendChild(btn);

        wrap.appendChild(left);
        wrap.appendChild(right);

        return wrap;
      }

      async function renderLessons(sectionKey) {
        // 1) –ø—Ä–æ–≥—Ä–µ—Å—Å (—á—Ç–æ–±—ã –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å —Ç–µ–∫—É—â–∏–π —É—Ä–æ–∫)
        let currentOrd = null;
        const uid = getTelegramUserId();
        if (uid) {
          try {
            const { data } = await apiGet(`/progress?user_id=${encodeURIComponent(uid)}`);
            const items = Array.isArray(data?.items) ? data.items : [];
            const p = items.find(x => x.section === sectionKey);
            if (p && p.ord) currentOrd = Number(p.ord);
          } catch {}
        }

        // 2) —É—Ä–æ–∫–∏
        const { data } = await apiGet(`/lessons?section=${encodeURIComponent(sectionKey)}`);
        const items = Array.isArray(data?.items) ? data.items : [];

        if (!items.length) {
          const c = card("–£—Ä–æ–∫–∏", "–ü–æ–∫–∞ —É—Ä–æ–∫–æ–≤ –Ω–µ—Ç. –î–æ–±–∞–≤—å —á–µ—Ä–µ–∑ /admin ‚Üí ¬´‚ûï –£—Ä–æ–∫ ‚Ä¶¬ª –∏ —Ñ–æ—Ä–≤–∞—Ä–¥ –ø–æ—Å—Ç–∞.");
          c.querySelector(".muted").appendChild(debugBlock("DEBUG: /lessons response", data));
          contentEl.appendChild(c);
          return;
        }

        const c = document.createElement("div");
        c.className = "card";
        c.innerHTML = `<div class="row"><div style="font-weight:800">–£—Ä–æ–∫–∏</div></div><div id="lessonList" style="margin-top:10px; display:flex; flex-direction:column; gap:10px;"></div>`;
        const list = c.querySelector("#lessonList");

        items.forEach((it) => {
          list.appendChild(lessonRow(sectionKey, it, currentOrd === Number(it.ord)));
        });

        c.appendChild(debugBlock("DEBUG: /lessons response", data));
        contentEl.appendChild(c);
      }

      async function renderLinks() {
        const { data } = await apiGet("/links");
        const items = Array.isArray(data?.items) ? data.items : [];

        if (!items.length) {
          const c = card("–°—Å—ã–ª–∫–∏", "–ü–æ–∫–∞ –ø—É—Å—Ç–æ.");
          c.querySelector(".muted").appendChild(debugBlock("DEBUG: /links response", data));
          contentEl.appendChild(c);
          return;
        }

        const wrap = document.createElement("div");
        wrap.className = "card";
        wrap.innerHTML = `<div class="row"><div style="font-weight:800">–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏</div></div><ul id="u"></ul>`;
        const ul = wrap.querySelector("#u");
        items.forEach(it => {
          const li = document.createElement("li");
          li.innerHTML = `<a href="${it.url}" target="_blank" rel="noreferrer">${it.title}</a>`;
          ul.appendChild(li);
        });
        wrap.appendChild(debugBlock("DEBUG: /links response", data));
        contentEl.appendChild(wrap);
      }

      async function renderNews() {
        const { data } = await apiGet("/news");
        const items = Array.isArray(data?.items) ? data.items : [];

        if (!items.length) {
          const c = card("–ù–æ–≤–æ—Å—Ç–∏", "–ü–æ–∫–∞ –ø—É—Å—Ç–æ.");
          c.querySelector(".muted").appendChild(debugBlock("DEBUG: /news response", data));
          contentEl.appendChild(c);
          return;
        }

        const wrap = document.createElement("div");
        wrap.className = "card";
        wrap.innerHTML = `<div class="row"><div style="font-weight:800">–ù–æ–≤–æ—Å—Ç–∏</div></div><ul id="u"></ul>`;
        const ul = wrap.querySelector("#u");
        items.forEach(it => {
          const li = document.createElement("li");
          const post = it.post_url || "";
          li.innerHTML = post
            ? `<a href="${post}" target="_blank" rel="noreferrer">${it.message_id}</a> <span class="muted">(${it.created_at})</span>`
            : `${it.message_id} <span class="muted">(${it.created_at})</span>`;
          ul.appendChild(li);
        });
        wrap.appendChild(debugBlock("DEBUG: /news response", data));
        contentEl.appendChild(wrap);
      }

      async function renderSection(key) {
        const s = sections.find(x => x.key === key) || sections[0];
        titleEl.textContent = s.label;
        contentEl.innerHTML = "";

        try {
          const meta = await loadMetaAndMarkApi();
          // –ú–ï–¢–ê –ù–ï –ü–û–ö–ê–ó–´–í–ê–ï–ú –í UI (—Ç–æ–ª—å–∫–æ debug)
          contentEl.appendChild(debugBlock("DEBUG: /meta response", meta));

          await renderContinueCard();

          if (key === "prep" || key === "steam") await renderLessons(key);
          if (key === "links") await renderLinks();
          if (key === "news") await renderNews();

          location.hash = key;
        } catch (e) {
          contentEl.innerHTML = "";
          const c = card("–û—à–∏–±–∫–∞ API", `<span class="danger">API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ CORS –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.</span><div class="small">API_BASE: ${API_BASE}</div>`);
          c.querySelector(".muted").appendChild(debugBlock("DEBUG: error", { message: e?.message, url: e?.url, data: e?.data }));
          contentEl.appendChild(c);
        }
      }

      function renderNav() {
        navEl.innerHTML = "";
        sections.forEach(s => {
          const btn = document.createElement("button");
          btn.className = "btn";
          btn.dataset.key = s.key;
          btn.innerHTML = `<span>${s.label}</span><span class="tag">—Ä–∞–∑–¥–µ–ª</span>`;
          btn.onclick = () => { setActive(s.key); renderSection(s.key); };
          navEl.appendChild(btn);
        });
      }

      // Telegram awareness
      const tg = window.Telegram?.WebApp;
      if (tg) {
        tgPillEl.textContent = "telegram webapp";
        try { tg.expand(); } catch {}
      } else {
        tgPillEl.textContent = "browser preview";
      }

      function syncDebugButton() {
        debugBtn.textContent = DEBUG ? "Debug: on" : "Debug: off";
        // –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º —Ç–µ–∫—É—â–∏–π —ç–∫—Ä–∞–Ω, —á—Ç–æ–±—ã pre –±–ª–æ–∫–∏ —Å–∫—Ä—ã–ª–∏—Å—å/–ø–æ–∫–∞–∑–∞–ª–∏—Å—å
        const current = (location.hash || "#prep").replace("#", "");
        renderSection(current);
      }

      debugBtn.onclick = () => {
        DEBUG = !DEBUG;
        syncDebugButton();
      };

      reloadBtn.onclick = () => {
        const current = (location.hash || "#prep").replace("#", "");
        renderSection(current);
      };

      renderNav();
      syncDebugButton();
      const initial = (location.hash || "#prep").replace("#", "");
      setActive(initial);
      renderSection(initial);
    </script>
  </body>
</html>
