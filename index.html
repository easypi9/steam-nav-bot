<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>STEAM –ù–∞–≤–∏–≥–∞—Ü–∏—è</title>
    <style>
      :root { --bg:#0b1220; --panel:#111a2e; --card:#0f1930; --text:#e8eefc; --muted:#a9b7db; --accent:#6aa7ff; --ok:#3ddc97; --bad:#ff6a6a; }
      * { box-sizing: border-box; }
      body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); }
      .app { display:flex; min-height:100vh; }
      .sidebar { width: 280px; background:var(--panel); padding:16px; border-right: 1px solid rgba(255,255,255,.08); }
      .brand { font-weight:700; letter-spacing:.2px; margin-bottom:10px; }
      .sub { color:var(--muted); font-size:13px; margin-bottom:14px; line-height:1.35; }
      .nav { display:flex; flex-direction:column; gap:8px; }
      .btn {
        width:100%; text-align:left; padding:12px 12px; border-radius:12px;
        border: 1px solid rgba(255,255,255,.10);
        background: rgba(255,255,255,.04); color:var(--text); cursor:pointer;
        display:flex; justify-content:space-between; align-items:center;
      }
      .btn:hover { border-color: rgba(106,167,255,.45); }
      .btn.active { outline: 2px solid rgba(106,167,255,.55); background: rgba(106,167,255,.10); }
      .tag { font-size:12px; color:var(--muted); }
      .main { flex:1; padding:18px; }
      .top { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:14px; }
      .title { font-size:18px; font-weight:700; }
      .pill { padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); color:var(--muted); font-size:12px; display:flex; gap:8px; align-items:center; }
      .dot { width:8px; height:8px; border-radius:50%; background: rgba(255,255,255,.22); }
      .dot.ok { background: var(--ok); }
      .dot.bad { background: var(--bad); }
      .card {
        background: var(--card);
        border: 1px solid rgba(255,255,255,.10);
        border-radius:16px;
        padding:14px;
      }
      .cards { display:grid; grid-template-columns: 1fr; gap:12px; }
      .row { display:flex; gap:10px; align-items:center; justify-content:space-between; }
      .muted { color:var(--muted); font-size:13px; line-height:1.45; }
      .link {
        display:inline-flex; gap:8px; align-items:center;
        text-decoration:none; color:var(--accent); font-weight:600;
      }
      .list { display:flex; flex-direction:column; gap:10px; margin-top:10px; }
      .item {
        padding:12px;
        border-radius:14px;
        border: 1px solid rgba(255,255,255,.10);
        background: rgba(255,255,255,.03);
        display:flex; justify-content:space-between; gap:12px; align-items:center;
      }
      .item .left { display:flex; flex-direction:column; gap:4px; }
      .item .t { font-weight:700; }
      .item .s { font-size:12px; color:var(--muted); }
      .small { font-size:12px; color:var(--muted); margin-top:10px; line-height:1.45; word-break: break-word; }
      .inputRow { display:flex; gap:10px; align-items:center; margin-top:10px; }
      .inp {
        flex:1;
        background: rgba(255,255,255,.04);
        border: 1px solid rgba(255,255,255,.12);
        color: var(--text);
        border-radius: 12px;
        padding: 10px 12px;
        outline: none;
      }
      .saveBtn {
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,.12);
        background: rgba(255,255,255,.06);
        color: var(--text);
        cursor:pointer;
        white-space: nowrap;
      }
      .saveBtn:hover { border-color: rgba(106,167,255,.45); }
      @media (max-width: 820px) {
        .sidebar { width: 220px; }
      }
      @media (max-width: 650px) {
        .app { flex-direction: column; }
        .sidebar { width:100%; border-right:none; border-bottom: 1px solid rgba(255,255,255,.08); }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <aside class="sidebar">
        <div class="brand">üìö STEAM –ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
        <div class="sub">–¢–µ–ø–µ—Ä—å WebApp —Ä–µ–∞–ª—å–Ω–æ –ø–∏–Ω–≥—É–µ—Ç API –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å.</div>

        <nav class="nav" id="nav"></nav>

        <div class="small" id="tgHint"></div>

        <div class="small" style="margin-top:10px;">
          <b>API URL</b> (–º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á–µ—Ä–µ–∑ <code>?api=...</code>):
          <div class="inputRow">
            <input class="inp" id="apiInput" placeholder="https://..." />
            <button class="saveBtn" id="apiSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
          <div class="small" id="apiSavedHint"></div>
        </div>
      </aside>

      <main class="main">
        <div class="top">
          <div class="title" id="screenTitle">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
          <div class="pill" id="pill"><span class="dot" id="dot"></span><span id="pillText">offline</span></div>
        </div>

        <div class="cards" id="content"></div>
      </main>
    </div>

    <script>
      // ====== CONFIG ======
      const DEFAULT_API_BASE = "https://steam-nav-bot-production.up.railway.app";

      // Allow override via ?api=https://...
      const urlParams = new URLSearchParams(location.search);
      const apiFromQuery = (urlParams.get("api") || "").trim();

      // Allow override via localStorage
      const apiFromStorage = (localStorage.getItem("API_BASE") || "").trim();

      // Final API base
      let API_BASE = apiFromQuery || apiFromStorage || DEFAULT_API_BASE;
      API_BASE = API_BASE.replace(/\/+$/, ""); // trim trailing /

      const sections = [
        { key: "prep", label: "üß© –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã–π –∫—É—Ä—Å", desc: "–£—Ä–æ–∫–∏ —Å –Ω—É–ª—è: –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ STEAM.", api: () => `${API_BASE}/lessons?section=prep` },
        { key: "steam", label: "üöÄ –ö—É—Ä—Å STEAM", desc: "–û—Å–Ω–æ–≤–Ω–æ–π –∫—É—Ä—Å, –º–æ–¥—É–ª–∏ –∏ –ø—Ä–∞–∫—Ç–∏–∫–∞.", api: () => `${API_BASE}/lessons?section=steam` },
        { key: "news", label: "üóû –ù–æ–≤–æ—Å—Ç–∏", desc: "–ê–Ω–æ–Ω—Å—ã, –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, —Å–æ–±—ã—Ç–∏—è.", api: () => `${API_BASE}/news` },
        { key: "links", label: "üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏", desc: "–†–µ—Å—É—Ä—Å—ã, —Å–µ—Ä–≤–∏—Å—ã, –º–∞—Ç–µ—Ä–∏–∞–ª—ã.", api: () => `${API_BASE}/links` },
      ];

      // ====== DOM ======
      const navEl = document.getElementById("nav");
      const contentEl = document.getElementById("content");
      const titleEl = document.getElementById("screenTitle");
      const pillTextEl = document.getElementById("pillText");
      const dotEl = document.getElementById("dot");
      const tgHintEl = document.getElementById("tgHint");

      const apiInputEl = document.getElementById("apiInput");
      const apiSaveEl = document.getElementById("apiSave");
      const apiSavedHintEl = document.getElementById("apiSavedHint");

      apiInputEl.value = API_BASE;
      apiSavedHintEl.textContent = apiFromQuery
        ? "–ò—Å—Ç–æ—á–Ω–∏–∫: –ø–∞—Ä–∞–º–µ—Ç—Ä ?api=..."
        : (apiFromStorage ? "–ò—Å—Ç–æ—á–Ω–∏–∫: localStorage" : "–ò—Å—Ç–æ—á–Ω–∏–∫: –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é");

      apiSaveEl.onclick = () => {
        const v = (apiInputEl.value || "").trim().replace(/\/+$/, "");
        if (!v) return;
        localStorage.setItem("API_BASE", v);
        location.href = location.pathname + location.hash; // reload without query
      };

      // ====== Helpers ======
      function setPill(status, text) {
        pillTextEl.textContent = text;
        dotEl.classList.remove("ok", "bad");
        if (status === "ok") dotEl.classList.add("ok");
        if (status === "bad") dotEl.classList.add("bad");
      }

      function setActive(key) {
        document.querySelectorAll(".btn").forEach(b => b.classList.toggle("active", b.dataset.key === key));
      }

      function elCard(title, body, extraHtml = "") {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <div class="row">
            <div style="font-weight:700">${title}</div>
          </div>
          <div class="muted" style="margin-top:8px; white-space:pre-line">${body}</div>
          ${extraHtml || ""}
        `;
        return div;
      }

      async function safeJson(url) {
        const r = await fetch(url, { method: "GET" });
        const ct = (r.headers.get("content-type") || "");
        const text = await r.text();
        let data = null;
        if (ct.includes("application/json")) {
          try { data = JSON.parse(text); } catch {}
        }
        if (!r.ok) {
          const err = new Error(`HTTP ${r.status} for ${url}`);
          err.status = r.status;
          err.body = text;
          throw err;
        }
        return data ?? text;
      }

      // ====== Telegram awareness ======
      const tg = window.Telegram?.WebApp;
      if (tg) {
        tgHintEl.textContent = "–û—Ç–∫—Ä—ã—Ç–æ –≤–Ω—É—Ç—Ä–∏ Telegram ‚úÖ";
        try { tg.expand(); } catch {}
      } else {
        tgHintEl.textContent = "–û—Ç–∫—Ä—ã—Ç–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä).";
      }

      // ====== API boot check ======
      async function pingApi() {
        setPill("bad", "API: checking‚Ä¶");
        try {
          const h = await safeJson(`${API_BASE}/health`);
          if (h && h.ok) {
            setPill("ok", "API: OK");
          } else {
            setPill("bad", "API: bad response");
          }
        } catch (e) {
          setPill("bad", "API: ERROR");
        }
      }

      // ====== Render ======
      function renderNav() {
        navEl.innerHTML = "";
        sections.forEach(s => {
          const btn = document.createElement("button");
          btn.className = "btn";
          btn.dataset.key = s.key;
          btn.innerHTML = `<span>${s.label}</span><span class="tag">—Ä–∞–∑–¥–µ–ª</span>`;
          btn.onclick = () => { setActive(s.key); renderSection(s.key); };
          navEl.appendChild(btn);
        });
      }

      async function renderSection(key) {
        const s = sections.find(x => x.key === key) || sections[0];
        titleEl.textContent = s.label;
        contentEl.innerHTML = "";

        // Always show API base + meta quick view
        contentEl.appendChild(elCard(
          "–°–≤—è–∑—å —Å API",
          `API_BASE: ${API_BASE}\n–†–∞–∑–¥–µ–ª: ${s.key}`
        ));

        // Try show /meta (nice for infra debug)
        try {
          const meta = await safeJson(`${API_BASE}/meta`);
          contentEl.appendChild(elCard(
            "META (–∏–∑ API)",
            `channel_username: ${meta.channel_username || ""}\nchat_url: ${meta.chat_url || ""}\nwebapp_origin: ${meta.webapp_origin || ""}`
          ));
        } catch (e) {
          contentEl.appendChild(elCard(
            "META (–∏–∑ API)",
            `–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å /meta.\n–ü—Ä–æ–≤–µ—Ä—å API –∏ CORS.\n\n${String(e.message || e)}`
          ));
        }

        // Load section data
        try {
          const data = await safeJson(s.api());
          const items = (data && data.items) ? data.items : [];
          const desc = s.desc;

          // Section header
          contentEl.appendChild(elCard(
            "–î–∞–Ω–Ω—ã–µ —Ä–∞–∑–¥–µ–ª–∞",
            `${desc}\n–ò—Å—Ç–æ—á–Ω–∏–∫: ${s.api()}`
          ));

          // Render list
          const wrap = document.createElement("div");
          wrap.className = "card";
          wrap.innerHTML = `<div style="font-weight:700">–≠–ª–µ–º–µ–Ω—Ç—ã</div><div class="muted" style="margin-top:6px">–ü–æ–∫–∞ –º–æ–∂–Ω–æ –¥–µ—Ä–∂–∞—Ç—å –ø—É—Å—Ç–æ ‚Äî –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç.</div>`;
          const list = document.createElement("div");
          list.className = "list";

          if (!items.length) {
            const empty = document.createElement("div");
            empty.className = "item";
            empty.innerHTML = `<div class="left"><div class="t">–ü—É—Å—Ç–æ</div><div class="s">–í –ë–î –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è —ç—Ç–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞</div></div><div class="tag">‚Äî</div>`;
            list.appendChild(empty);
          } else {
            items.forEach((it, idx) => {
              // news: message_id, created_at, post_url
              // lessons: ord, title, message_id, post_url
              // links: title, url, ord
              const title =
                it.title ||
                (typeof it.ord === "number" ? `–£—Ä–æ–∫ ${it.ord}` : `–≠–ª–µ–º–µ–Ω—Ç ${idx + 1}`);

              const subtitle =
                it.url ? it.url :
                it.post_url ? it.post_url :
                it.created_at ? it.created_at :
                (it.message_id ? `message_id: ${it.message_id}` : "");

              const href = it.url || it.post_url || "";

              const row = document.createElement("div");
              row.className = "item";
              row.innerHTML = `
                <div class="left">
                  <div class="t">${escapeHtml(title)}</div>
                  <div class="s">${escapeHtml(subtitle)}</div>
                </div>
                ${href ? `<a class="link" href="${href}" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å ‚Üó</a>` : `<span class="tag">‚Äî</span>`}
              `;
              list.appendChild(row);
            });
          }

          wrap.appendChild(list);
          contentEl.appendChild(wrap);
        } catch (e) {
          contentEl.appendChild(elCard(
            "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞–∑–¥–µ–ª–∞",
            `–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.\nURL: ${s.api()}\n\n${String(e.message || e)}`
          ));
        }

        location.hash = key;
      }

      function escapeHtml(s) {
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      // ====== Start ======
      renderNav();
      pingApi();

      const initial = (location.hash || "#prep").replace("#", "");
      setActive(initial);
      renderSection(initial);
    </script>
  </body>
</html>
